# 技術アーキテクチャ

**このドキュメントは開発者向け。ユーザーには見せない。**

## 設計原則

1. **技術を隠す** - ユーザーにNostrを意識させない
2. **統合表示** - チャットもSNSも一つのストリーム
3. **軽量常駐** - ゲーム中でも邪魔にならない
4. **摩擦ゼロ** - 開いた瞬間に使える

## 技術スタック

| レイヤー | 技術 |
|----------|------|
| ランタイム | Tauri (Rust) |
| フロント | React + TypeScript |
| プロトコル | Nostr (NIP-01, NIP-28, NIP-07) |
| Nostr SDK | nostr-sdk (Rust) |

## 統合ストリームの仕組み

ユーザーには「一つの流れ」に見える。裏では複数のkindを購読。

```
┌─────────────────────────────────────────┐
│              統合ストリーム              │
├─────────────────────────────────────────┤
│  kind:42 (チャットメッセージ)            │
│  + kind:1 (テキスト投稿)                │
│  + kind:6 (リポスト)                    │
│  + kind:7 (リアクション) ※表示用        │
├─────────────────────────────────────────┤
│         時系列で混合して表示             │
└─────────────────────────────────────────┘
```

### 全チャンネル統合

サイロ化を防ぐため、全NIP-28チャンネルを一括購読。

```rust
// 全チャンネルのメッセージを購読
let filter = Filter::new()
    .kind(Kind::ChannelMessage)  // kind:42
    .limit(100);

// 全テキスト投稿も購読
let filter2 = Filter::new()
    .kind(Kind::TextNote)  // kind:1
    .limit(100);
```

人口が少ないうちは全部見せる。
増えたらフィルタリング機能を足す。

## ディレクトリ構造

```
gilga/
├── src-tauri/              # Rustバックエンド
│   ├── src/
│   │   ├── main.rs         # エントリーポイント
│   │   ├── lib.rs          # Tauriコマンド定義
│   │   └── nostr_client.rs # Nostrクライアント全機能
│   └── Cargo.toml
├── src/                    # Reactフロント
│   ├── App.tsx             # メインUI（ストリーム表示）
│   ├── App.css
│   ├── Settings.tsx        # 設定画面
│   ├── Settings.css
│   └── main.tsx
├── docs/                   # ドキュメント
└── CLAUDE.md
```

## 鍵管理

```
初回起動
    │
    ├─ 鍵ペアを自動生成
    │
    ├─ ~/.gilga/keys.json に保存（ローカルファイル）
    │
    └─ 即座に使える状態に
```

### 実装済み機能

- 鍵の自動生成・永続化
- 秘密鍵のエクスポート（nsec形式）
- 秘密鍵のインポート（既存Nostrユーザー向け）

### ユーザー向けUI

設定画面で「鍵の管理」セクションとして提供。
ただし技術用語は最小限に抑える。

## リレー管理

### デフォルトリレー

```
wss://relay.damus.io
wss://nos.lol
wss://relay-jp.nostr.wirednet.jp
```

### 実装済み機能

- リレーの追加・削除
- ~/.gilga/relays.json に永続化
- 設定画面で「接続先リレー」として管理

## オーバーレイ実装

```rust
WindowBuilder::new(app, "overlay", WindowUrl::App("index.html".into()))
    .transparent(true)
    .decorations(false)
    .always_on_top(true)
    .skip_taskbar(true)
    .resizable(false)
    .build()?;
```

- 黒背景、半透明
- 画面端に常駐
- ホットキーで表示/非表示

## パフォーマンス目標

| 指標 | 目標 |
|------|------|
| 起動〜表示 | < 1.5秒 |
| 投稿〜表示 | < 200ms |
| 常駐CPU | < 2% |
| 常駐メモリ | < 120MB |

## NIP対応（開発者向け）

| NIP | 用途 | 実装状況 |
|-----|------|---------|
| NIP-01 | 基本イベント（kind:1 テキスト投稿） | 実装済み |
| NIP-01 | kind:0 メタデータ（プロフィール） | 実装済み |
| NIP-19 | bech32エンコード（npub/nsec） | 実装済み |
| NIP-28 | パブリックチャット（kind:42） | 実装済み |

**Zapは実装しない。** おねだりUIはGilgaの思想に反する。

## 互換性

他のNostrクライアントと完全互換。

- Gilgaで投稿 → Damus/Amethystで見える
- 0xchatのチャンネル → Gilgaで見える
- 独自拡張なし

ただし「Nostrと互換」とは言わない。
ユーザーには「他のアプリでも見れる」程度に伝える。
